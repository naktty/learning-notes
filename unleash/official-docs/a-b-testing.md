# フィーチャーフラグを使用したA/Bテストの方法

フィーチャーフラグは、最小限のコード変更でA/Bテストまたは多変量テストを実行する優れた方法です。Unleashには、すぐに始められる組み込み機能が用意されています。このチュートリアルでは、Unleashを使用してアプリケーションでA/Bテストを実行する方法を説明します。

## フィーチャーフラグを使用したA/Bテストの実施方法

このチュートリアルに従うには、フィーチャーフラグを作成および管理するためのUnleashインスタンスへのアクセスが必要です。ローカルでの実行やUnleash SaaSインスタンスの使用など、オプションについてはクイックスタートドキュメントをご覧ください。

Unleashをセットアップしたら、SDKの1つを通じてアプリケーションからUnleashと通信できます。

このチュートリアルでは、以下の方法を学びます：

1. テスト用のアプリケーションバリアントを定義するためのフィーチャーフラグの使用方法
2. 各テストバリアントに特定のユーザーをターゲティングする方法
3. テストバリアントのクロスセッション可視性の管理
4. フィーチャーフラグのインプレッションデータを変換結果に接続する方法
5. 勝者バリアントを全ユーザーにロールアウトする方法

また、マルチアームバンディットテストなどの高度なA/Bテスト戦略をフィーチャーフラグを使用して自動化する方法についても学びます。

### フィーチャーフラグの作成

A/Bテストを行うために、ロールアウト戦略を実装するフィーチャーフラグを作成します。その後、戦略とその設定方法について説明します。

Unleash管理UIで、プロジェクトを開き、**新規フィーチャーフラグ**をクリックします。

![use-case-new-flag](https://docs.getunleash.io/assets/images/use-case-new-flag-12480e6ebbd3fe8daf0a5e4623c4f0f7.png)

次に、フィーチャー・フラグを作成し、それをオンにする。

機能フラグはさまざまな目的に使用することができるが、我々は実験が重要であると考え、独自のフラグタイプを設けている。実験フラグには、実験を実行し、実験が成功したかどうかを知るのに十分なデータを収集するのに適した寿命がある。今回作成する機能フラッグは、実験フラッグタイプとみなされる。

![use-case-create-experiment-flag](https://docs.getunleash.io/assets/images/use-case-create-experiment-flag-de254ada633a69b2986ae3ad8e7c1340.png)

入力が完了したら、Create feature flagをクリックします。

これで新しい機能フラグを使用する準備が整いました。次に、フラグのA/Bテスト戦略を設定します。


### A/Bテストのためのユーザーターゲティング

A/Bテスト戦略により、以下が可能になります：

* 新機能に露出するユーザーの割合の決定
* 機能の各バージョンに露出するユーザーの割合の決定

それに応じてユーザーをターゲットにするために、アクティベーション戦略を作りましょう。このUnleashのコンセプトは、誰が特定のフラグにさらされるかを定義します。Unleashには複数のアクティベーションストラテジーがあらかじめ設定されており、機能をリリースしたいパラメータに応じて、指定したユーザーに対してのみ機能を有効にすることができます。

異なるストラテジーは異なるパラメーターを使用する。定義済みの戦略はUnleashにバンドルされている。デフォルトのストラテジーは100%への段階的なロールアウトで、これはすべてのユーザーに対して機能が有効になっていることを意味します。このチュートリアルでは、機能を利用できるユーザーの割合を調整します。

メモ：アクティベーション戦略はサーバー上で定義されます。サーバーサイドSDKの場合、アクティベーション戦略の実装はクライアントサイドで行われます。フロントエンドSDKの場合、機能はサーバー側で計算されます。

機能フラグを開き、Add strategyをクリックします。
![use-case-experiment-add-strategy](https://docs.getunleash.io/assets/images/use-case-experiment-add-strategy-240e40cf7095d21228882129988d0bb9.png)

段階的ロールアウト戦略フォームには、機能のロールアウトをコントロールする複数のフィールドがあります。作成するA/Bテストに関連したストラテジーの名前を付けることができますが、これはオプションのフィールドです。
![use-case-experiment-gradual-rollout](https://docs.getunleash.io/assets/images/use-case-experiment-gradual-rollout-12a267da93365bf7c0bb876a69e73685.png)

次に、ロールアウトのパーセンテージを設定し、ユーザーの一定部分のみがターゲットになるようにします。例えば、全ユーザーの35％が対象となるようにダイヤルを調整することができます。残りの割合のユーザーは、新機能のバリエーションを体験することはありません。ロールアウトダイヤルを調整して、その機能がターゲットとするユーザーの割合を設定するか、100%のままにしてすべてのユーザーをターゲットにします。

デフォルトのストラテジーをさらに高度に拡張したものが2つあり、フォームでカスタマイズすることができます
* ストラテジーのバリエーション
* 戦略の制約

ストラテジーのバリアントとコンストレイントで、ストラテジー全体を拡張できます。
これらは、ロールアウトのパーセンテージを超えて、機能のより詳細な条件を定義するのに役立ちます。
ストラテジーバリアントを使用してA/Bテストを構成することをお勧めします。

ストラテジーバリアントでは、あるフラグが有効になっているときに、特定のユーザーベースに特定のバージョンの機能を公開することができます。
そしてデータを収集し、どのバリアントがより良いパフォーマンスかを判断します。

アクティベーション戦略でストラテジーバリアントを使用することは、UnleashとアプリケーションでA/Bテストを実行する標準的な方法です。
![tutorial-building-blocks-strategy-variants](https://docs.getunleash.io/assets/images/tutorial-building-blocks-strategy-variants-5c33f5120ad572aa709f97c350963161.png)

variant にはそれを定義する三つの要素があります：

* 名前: ストラテジーの variant の中で一意でなければなりません。通常はこの名前を使ってクライアントで variant を識別します。
* 重み： variant weight は一人のユーザがこの variant を手に入れる可能性を表します。
* オプションのペイロード： variant は関連するペイロードを持つこともできます。フラグの有効/無効に加えてデータを返したい場合に定義します。
    * タイプ： これはペイロードのデータフォーマットを定義し、string、json、csv、number のいずれかを指定します。
    * 値： variant に関連付けられたペイロードデータ。データのフォーマットは type プロパティで指定されたものと一致しなければならない。
グラデーションロールアウトストラテジーを開き、Variants タブを選択し、Add variant をクリックします。
バリアントの一意な名前を入力します。このチュートリアルでは、variantA と variantB の 2 つの variant を作成します。
実際のユースケースでは、参照する機能のバージョンに関連する、より具体的でわかりやすい名前を推奨します。
より多くのバージョンをテストする必要があれば、さらに variant を作ってください。

次に、variant weight と呼ばれる、それぞれの variant でターゲットにするユーザの割合を決めます。
デフォルトでは、2 つの variant の間で 50% のユーザーをターゲットにします。
例えば、先に定義したロールアウトの割合からターゲットとなるユーザの 35% 内のユーザの 50% が variantA を経験することになります。
Custom percentage を切り替えて、デフォルトの variant weight を変更してください。
![use-case-experiment-variants](https://docs.getunleash.io/assets/images/use-case-experiment-variants-4ced8005a835e7f4c5d59f57a1afd842.png)

### ユーザーセッションの振る舞いを管理

Unleashは、開発者がA/Bテストを効果的に実行できるように構築されています。
A/B テスト戦略を実施する上で重要な要素の一つは、複数のユーザーセッションにまたがって、各ユーザーに一貫した体験を維持することです。
例えば、ユーザ uuid1234 はセッションに関係なく variantA のターゲットになります。
variantAを得たユーザの元のサブセットは、時間の経過とともにその機能のバリエーションを体験し続けることになります。
Unleash ではこれを stickiness と呼んでいます。
段階的ロールアウトフォームで、粘着性のパラメータを定義できます。
デフォルトでは、粘着性は sessionId と groupId によって計算されます。

### 主要なパフォーマンス指標のためのA/Bテストの追跡

A/Bテスト戦略は、機能のロールアウト結果をユーザーに追跡し、コンバージョン率やページ滞在時間などの主要な指標に結びつけることができる場合に最も有用です。
チームがA/Bテストの目標を明確に定義している場合、Unleashを使用して結果が主要な指標にどのように結びついているかを分析できます。
このデータを収集する方法の1つは、フィーチャーフラグごとのインプレッションデータを有効にすることです。
インプレッションデータには、特定のフィーチャーフラグのアクティベーションチェックに関する情報が含まれています。

ロールアウトのインプレッションデータを有効にするには、機能フラグに移動し、インプレッションデータを有効にします。

![use-case-experiment-enable-impression-data](https://docs.getunleash.io/assets/images/use-case-experiment-enable-impression-data-ad2af69904a9723f13654cfdcccef05d.png)

次に、アプリケーション・コードで、SDK を使用して、インプレッション・イベントをリアルタイムで取得します。
クライアントSDKは、isEnabledまたはgetVariantを呼び出したときにインプレッションイベントを発行します。
一部のフロントエンドSDKは、フラグが有効な場合にのみインプレッションイベントを発行します。
特定のユーザーアクションを追跡するために、カスタムイベントタイプを定義できます。
A/Bテストのユーザーが新機能を持っていることを確認したい場合、UnleashはisEnabledイベントを受け取ります。
バリアントを作成した場合、getVariantイベントタイプがUnleashに送信されます。

ストラテジーバリアントはインプレッションデータと連動します。
バリアントの名前が分析ツールに送られ、ログから単純な true/false を見るのではなく、何が起こったかをよりよく理解することができます。

アプリのインプレッションデータからの出力は次のコードスニペットのようになります：

```json
{
    "eventType": "getVariant",
    "eventId": "c41aa58b-d2c7-45cf-b668-7267f465e01a",
    "context": {
        "sessionId": 386689528,
        "appName": "my-example-app",
        "environment": "default"
    },
    "enabled": true,
    "featureName": "ab-testing-example",
    "impressionData": true,
    "variant": "variantA"
}
```
アプリでインプレッションイベントをキャプチャするには、言語とフレームワーク固有のチュートリアルに従います。

アプリケーションでインプレッションイベントをキャプチャできるようになったので、使用する分析ツールやデータウェアハウスに送信するための正しいデータフィールドとフォーマットを設定できます。

以下は、Google Analyticsに送信するためにアプリケーションでインプレッションデータを収集する2つのコード例です：

例1:
```typescript
unleash.on(UnleashEvents.Impression, (e: ImpressionEvent) => {
    // Google Analyticsに送信、以下のような形で
    gtag("event", "screen_view", {
        app_name: e.context.appName,
        feature: e.featureName,
        treatment: e.enabled ? e.variant : "Control", // コントロールに機能無効を使用する場合
    });
});
```

例2:
```typescript
unleash.on(UnleashEvents.Impression, (e: ImpressionEvent) => {
    if (e.enabled) {
        // Google Analyticsに送信、以下のような形で
        gtag("event", "screen_view", {
            app_name: e.context.appName,
            feature: e.featureName,
            treatment: e.variant, // コントロール治療にバリアントを使用する場合
        });
    }
});
```

これらのコードスニペットの例では、`e`はインプレッションデータ出力からのイベントオブジェクトを参照しています。
これらの値を、分析ツールやデータウェアハウスへの呼び出しを行う適切な関数にマッピングしてください。

例1のように、「無効な機能」状態を「コントロールグループ」として使用したい場合があります。

または、例2のように、機能を100%のユーザーに公開し、2つのバリアント（「コントロール」と「テスト」）を使用することもできます。
どちらの場合も、バリアントは常に「テスト」グループに使用されます。
違いは「コントロール」グループの使用方法によって決まります。

コントロールグループに機能を無効にする利点は、実験にさらされているユーザーの数を、そうでないユーザーと比較して確認できることです。
バリアントのみを使用する場合（テストグループとコントロールグループの両方に）、機能指標が100%露出しているように見える可能性があり、バリアントを詳しく見る必要があります。

以下は、インプレッションイベントデータを含むGoogle Analyticsからのペイロードの例です：

```json
{
    "client_id": "unleash_client"
    "user_id": "uuid1234"
    "timestamp_micros": "1730407349525000"
    "non_personalized_ads": true
    "events": [
        {
            "name":"select_item"
            "params": {
                "items":[]
                "event":"screen_view"
                "app_name":"myAppName"
                "feature":"myFeatureName"
                "treatment":"variantValue"
            }
        }
    ]
}
```

フィーチャーフラグのインプレッションデータを有効にし、アプリケーションコード内でイベントをリッスンすることで、このデータを統合された分析ツールに流すことで、より速く情報に基づいた意思決定を行い、実際のユーザー行動に基づいて戦略を調整することができます。

---
**👇この辺りから確認してない👇**
---

### 勝者バリアントを全ユーザーにロールアウト

A/Bテストを実施し、機能のパフォーマンスをユーザーのサブセットで測定した後、どのバリアントが最適な体験かを決定し、そのバリアントを本番環境の全ユーザーにロールアウトすることができます。

Unleashは、どの環境で機能をリリースするか、いつリリースするか、誰にリリースするかをコントロールできます。
各チームのリリース戦略は異なる場合がありますが、A/Bテストの全体的な目標は、アプリのUIの変更、Webパフォーマンスの改善、バックエンドの最適化など、ユーザーにとって最も効果的な体験を選択することです。

勝者バリアントをロールアウトする際、フラグはすでに本番環境でオンになっている可能性があります。
Unleash管理画面でロールアウト戦略の設定を調整して、ユーザーベースの100%にリリースします。

フラグが時間とともに100%のユーザーに利用可能になった後、フラグをアーカイブし、コードベースをクリーンアップします。

## エンタープライズ自動化によるA/Bテスト

Unleashでは、APIを通じてフィーチャーフラグを自動化し、アクションやシグナルに基づいて動的にフラグを有効/無効にすることができます。A/Bテストを実行する際、プロジェクトを設定して、定義したアプリケーション指標としきい値に応じてタスクを実行することができます。例えば、ユーザーベースの一部をターゲットにした実験機能でエラーが記録された場合、アクションが自動的に機能を無効にし、チームが調査する時間を確保しながら、ユーザーにシームレスな代替体験を提供することができます。同様に、APIを使用して、ユーザーが一方のバリアントをもう一方のバリアントよりも多く使用している場合に、機能のバリエーションのターゲットユーザーの割合を変更することができます。

### マルチアームバンディットテストによる勝者バリアントの発見

複数の組み合わせを持つ複雑な多変量テストを実行する場合、機能の最適なバリエーションを見つけるプロセスを自動化することは、大規模なユーザーベースを持つ組織にとって最も最適で費用対効果の高いアプローチです。マルチアームバンディットテストは、A/Bテストで使用される強力な手法で、コンバージョン率やクリックスルー率などの望ましい結果を最大化する方法で、機能やアプリケーションの異なるバージョンにトラフィックを割り当てます。このアプローチは従来のA/Bテストに比べていくつかの利点があり、大規模な企業チームにとって実行可能なソリューションです。

![traditional-ab-testing-vs-multi-arm-bandit](https://docs.getunleash.io/assets/images/traditional-ab-testing-vs-multi-arm-bandit-5c33f5120ad572aa709f97c350963161.png)

Unleashで作成したバリアントは、マルチバンディットのコンテキストでは「アーム」となります。イプシロングリーディやトンプソンサンプリングなどのマルチアームバンディットアルゴリズムを使用して、各バリアントのパフォーマンスに基づいて動的にトラフィックを割り当てることができます。異なるバリアントで実験を行い、より多くの情報を収集します。より良いパフォーマンスを示しているバリアントにより多くのトラフィックを割り当てます。テストが進むにつれて、アルゴリズムは有望な結果を示しているバリアントを優先するようにトラフィックの割り当てを調整します。テスト完了後、データを分析して勝者バリアントを決定できます。パフォーマンスに基づいて動的にトラフィックを割り当てることで、マルチアームバンディットテストは従来のA/Bテストよりも迅速に勝者バリアントを特定できます。

Unleashを使用してマルチアームバンディットテストを実施するには、以下の手順に従います：

1. フィーチャーフラグのインプレッションデータを有効にして、各バリアントのパフォーマンスから必要なデータを収集します
2. アプリケーションコードでインプレッションイベントをキャプチャします
3. アプリケーションコードからキャプチャしたインプレッションイベントを外部分析ツールに送信します
4. Unleash APIを使用して、パフォーマンスに基づいて各バリアントのトラフィックを動的に調整します

このアプローチにより、パフォーマンスの低いバリアントにトラフィックを割り当てることに関連する「後悔」を最小限に抑えることができます。Unleashを使用したマルチアームバンディットテストは、季節的な変動やユーザー行動の変化などの変化する条件に適応できます。場合によっては、ユーザーが長期間にわたって最適でない体験にさらされないようにするために使用できます。

A/Bテストは、ユーザーアクティビティやその他の選択した指標に基づいてフラグを自動化する際に、追加の安全対策を設けて安全かつ戦略的に実行されます。

### まとめ

Unleashを使用したA/Bテストは、以下の利点を提供します：

- 最小限のコード変更で実験を実施可能
- ユーザーセッション間での一貫した体験の維持
- 詳細なインプレッションデータの収集と分析
- 高度な自動化オプション
- エンタープライズレベルの安全性と制御

フィーチャーフラグを使用したA/Bテストは、製品開発プロセスの重要な部分となり、データに基づいた意思決定を可能にし、ユーザー体験の継続的な改善を支援します。